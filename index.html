<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear C√≥digo QR</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="header">
            <nav>
                <a href="index.html">C√≥digo QR</a>
                <a href="asistencia.html">Ver asistencia</a>
                <a href="generar_qr.html">Generar QR</a>
            </nav>
        </div>
    </header>

    <div class="container">
        <h2>üì∑ Escanear C√≥digo QR</h2>
        <div id="reader"></div>
        <p id="result-container">Resultado: <span id="result">Esperando escaneo...</span></p>
    </div>

    <div id="confirmation-screen" style="display: none;">
        <h2>‚úÖ Escaneado con √©xito</h2>
        <p id="confirmation-message">Los datos han sido registrados correctamente.</p>
    </div>

    <script>
        let html5QrCode;

        // Funci√≥n que se llama cuando el c√≥digo QR es escaneado con √©xito
        function onScanSuccess(decodedText) {
            if (verificarCodigoUnico(decodedText)) {
                registrarAsistencia(decodedText);
                mostrarConfirmacion("‚úÖ Escaneado con √©xito", "Los datos han sido registrados correctamente.");
                detenerEscaneo();
                setTimeout(() => {
                    ocultarConfirmacion();
                    iniciarEscaneo();
                }, 5000); // Esperar 5 segundos y luego reiniciar el escaneo
            } else {
                mostrarConfirmacion("‚ö†Ô∏è C√≥digo ya escaneado", "Este c√≥digo ya ha sido escaneado previamente.");
                detenerEscaneo();
                setTimeout(() => {
                    ocultarConfirmacion();
                    iniciarEscaneo();
                }, 5000); // Esperar 5 segundos y luego reiniciar el escaneo
            }
        }

        // Funci√≥n para registrar los datos de asistencia en localStorage
        function registrarAsistencia(decodedText) {
            try {
                let data = JSON.parse(decodedText);  // Suponiendo que el c√≥digo QR contiene un objeto JSON
                let asistencia = JSON.parse(localStorage.getItem("asistencia")) || [];

                // Verificar si ya existe la matr√≠cula en la lista de asistencia
                let existe = asistencia.some(a => a.matricula === data.matricula);
                if (existe) {
                    alert("‚ö†Ô∏è C√≥digo ya escaneado. Este c√≥digo ya ha sido escaneado previamente.");
                    return;
                }

                // Agregar los datos escaneados a la lista de asistencia
                asistencia.push({
                    matricula: data.matricula,
                    nombre: data.nombre,
                    fecha: new Date().toLocaleString()  // Fecha y hora actual
                });

                // Guardar la lista de asistencia en localStorage
                localStorage.setItem("asistencia", JSON.stringify(asistencia));

                // Registrar el c√≥digo escaneado
                registrarCodigoEscaneado(data.matricula);

                // Llamar a la funci√≥n que actualiza la tabla en la p√°gina de asistencia
                cargarAsistencia();
            } catch (error) {
                console.error("Error al procesar el c√≥digo QR: ", error);
            }
        }

        // Funci√≥n para registrar el c√≥digo escaneado y evitar duplicados
        function registrarCodigoEscaneado(matricula) {
            let codigosEscaneados = JSON.parse(localStorage.getItem("codigosEscaneados")) || [];
            codigosEscaneados.push(matricula);
            localStorage.setItem("codigosEscaneados", JSON.stringify(codigosEscaneados));
        }

        // Funci√≥n para verificar si el c√≥digo QR es √∫nico
        function verificarCodigoUnico(decodedText) {
            let data = JSON.parse(decodedText);  // Suponiendo que el c√≥digo QR contiene un objeto JSON
            let codigosEscaneados = JSON.parse(localStorage.getItem("codigosEscaneados")) || [];
            return !codigosEscaneados.includes(data.matricula);
        }

        // Funci√≥n para mostrar un mensaje de confirmaci√≥n despu√©s de escanear el c√≥digo QR
        function mostrarConfirmacion(titulo, mensaje) {
            document.getElementById("reader").style.display = "none";
            document.getElementById("result-container").style.display = "none";
            document.getElementById("confirmation-screen").style.display = "block";
            document.getElementById("confirmation-screen").innerHTML = `<h2>${titulo}</h2><p>${mensaje}</p>`;
        }

        // Funci√≥n para ocultar el mensaje de confirmaci√≥n y volver a mostrar el esc√°ner
        function ocultarConfirmacion() {
            document.getElementById("confirmation-screen").style.display = "none";
            document.getElementById("reader").style.display = "block";
            document.getElementById("result-container").style.display = "block";
            document.getElementById("result").innerText = "Esperando escaneo...";
        }

        // Funci√≥n para iniciar el escaneo de QR
        function iniciarEscaneo() {
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(
                { facingMode: "environment" },  // Utilizar la c√°mara trasera si est√° disponible
                { fps: 10, qrbox: 250 },  // Configurar el frame rate y tama√±o del cuadro para el escaneo
                onScanSuccess  // Funci√≥n de √©xito al escanear el c√≥digo QR
            );
        }

        // Funci√≥n para detener el escaneo
        function detenerEscaneo() {
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    console.log("Escaneo detenido");
                }).catch(err => {
                    console.error("Error al detener el escaneo:", err);
                });
            }
        }

        // Iniciar escaneo al cargar la p√°gina
        window.onload = iniciarEscaneo;
    </script>
</body>
</html>
